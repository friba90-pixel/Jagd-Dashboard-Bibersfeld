<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêó Jagd Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-dark: #0a0e12;
            --bg-card: #141922;
            --bg-card-hover: #1a1f2e;
            --accent-green: #4ade80;
            --accent-orange: #fb923c;
            --accent-red: #f87171;
            --accent-yellow: #fbbf24;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --border: #1f2937;
        }
        
        body {
            font-family: 'IBM Plex Mono', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 1rem;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(74, 222, 128, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(251, 146, 60, 0.05) 0%, transparent 50%);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            letter-spacing: 0.1em;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .zeitraum-select {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.05em;
        }
        
        .zeitraum-select:hover {
            border-color: var(--accent-green);
        }
        
        .zeitraum-select:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.2);
        }
        
        .btn {
            background: var(--accent-green);
            color: var(--bg-dark);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.05em;
        }
        
        .btn:hover {
            background: var(--accent-orange);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-green);
        }
        
        .date-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }
        
        /* Eingabe-Bereich */
        .input-section {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .input-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }
        
        .text-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 1rem;
            border-radius: 0.8rem;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        
        .text-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);
        }
        
        .text-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }
        
        .input-buttons {
            display: flex;
            gap: 1rem;
        }
        
        .mic-btn-small {
            background: var(--bg-card-hover);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 1rem;
            min-width: 60px;
            border-radius: 0.8rem;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .mic-btn-small:hover {
            border-color: var(--accent-green);
            transform: translateY(-2px);
        }
        
        .mic-btn-small.listening {
            border-color: var(--accent-green);
            background: rgba(74, 222, 128, 0.1);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        /* Vorschau */
        .preview-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: none;
        }
        
        .preview-card.active {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .preview-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--accent-green);
            margin-bottom: 1rem;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .preview-item {
            background: rgba(255, 255, 255, 0.02);
            padding: 0.8rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }
        
        .preview-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }
        
        .preview-value {
            font-size: 1rem;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease backwards;
        }
        
        .card:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-green);
            transform: translateY(-2px);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .card-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 0.1em;
            color: var(--accent-green);
        }
        
        .badge {
            background: var(--accent-green);
            color: var(--bg-dark);
            padding: 0.3rem 0.8rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.02);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-green);
            font-family: 'Bebas Neue', sans-serif;
            letter-spacing: 0.05em;
        }
        
        .stat-sub {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
        }
        
        /* Forecast */
        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.8rem;
            margin-bottom: 1rem;
        }
        
        .forecast-day {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 0.8rem;
            padding: 1rem;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .forecast-day:hover {
            background: rgba(74, 222, 128, 0.05);
            border-color: var(--accent-green);
        }
        
        .forecast-day.high-prob {
            border-color: var(--accent-green);
            background: rgba(74, 222, 128, 0.08);
        }
        
        .forecast-day.medium-prob {
            border-color: var(--accent-yellow);
            background: rgba(251, 191, 36, 0.08);
        }
        
        .forecast-day.low-prob {
            border-color: var(--accent-red);
            background: rgba(248, 113, 113, 0.05);
        }
        
        .forecast-date {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }
        
        .forecast-weekday {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .forecast-prob {
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0.5rem 0;
            font-family: 'Bebas Neue', sans-serif;
        }
        
        .forecast-prob.high { color: var(--accent-green); }
        .forecast-prob.medium { color: var(--accent-yellow); }
        .forecast-prob.low { color: var(--accent-red); }
        
        .forecast-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 0.3rem;
        }
        
        .info-box {
            background: rgba(74, 222, 128, 0.05);
            border: 1px solid var(--accent-green);
            border-radius: 0.8rem;
            padding: 1rem;
        }
        
        .info-title {
            font-weight: 600;
            color: var(--accent-green);
            margin-bottom: 0.5rem;
        }
        
        .info-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--accent-green);
            font-size: 1.2rem;
        }
        
        .success-message {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
            padding: 1rem;
            border-radius: 0.8rem;
            margin-bottom: 1rem;
            text-align: center;
            display: none;
        }
        
        .success-message.active {
            display: block;
            animation: slideIn 0.3s ease;
        }
        
        .error {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 1rem;
            border-radius: 0.8rem;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .forecast-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header-actions {
                width: 100%;
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .input-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>üêó JAGD DASHBOARD</h1>
                <div class="date-info" id="dateInfo">Lade Daten...</div>
            </div>
            <div class="header-actions">
                <select id="zeitraumFilter" class="zeitraum-select" onchange="applyZeitraumFilter()">
                    <option value="all">All Time</option>
                    <option value="12m">Letzte 12 Monate</option>
                    <option value="3m" selected>Letzte 3 Monate</option>
                    <option value="1m">Letzter Monat</option>
                </select>
                <button class="btn btn-secondary" onclick="loadData()">üîÑ Aktualisieren</button>
            </div>
        </header>
        
        <div class="success-message" id="successMessage">
            ‚úÖ Besuch erfolgreich gespeichert!
        </div>
        
        <!-- Eingabe-Bereich -->
        <div class="input-section">
            <div class="input-title">+ Neuer Besuch</div>
            <textarea 
                class="text-input" 
                id="textInput" 
                placeholder="z.B. 'Heute Nacht zwei Sauen S√§gem√ºhle von 5:20 bis 7:10'"
                rows="2"
            ></textarea>
            <div class="input-buttons">
                <button class="btn" onclick="analyzeText()" style="flex: 1;">‚å®Ô∏è Analysieren</button>
                <button class="mic-btn-small" id="micButton" onclick="toggleListening()" title="Spracheingabe">üé§</button>
            </div>
        </div>
        
        <!-- Vorschau -->
        <div class="preview-card" id="previewCard">
            <div class="preview-title">Vorschau - Bitte pr√ºfen</div>
            <div class="preview-grid">
                <div class="preview-item">
                    <div class="preview-label">Datum</div>
                    <div class="preview-value" id="previewDatum">-</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Uhrzeit Von</div>
                    <div class="preview-value" id="previewUhrzeitVon">-</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Uhrzeit Bis</div>
                    <div class="preview-value" id="previewUhrzeitBis">-</div>
                </div>
                <div class="preview-item">
                    <div class="preview-label">Kirrung</div>
                    <div class="preview-value" id="previewKirrung">-</div>
                </div>
                <div class="preview-item" style="grid-column: span 2;">
                    <div class="preview-label">Anzahl</div>
                    <div class="preview-value" id="previewAnzahl">-</div>
                </div>
                <div class="preview-item" style="grid-column: span 2;">
                    <div class="preview-label">Notizen</div>
                    <div class="preview-value" id="previewNotizen" style="white-space: normal; font-size: 0.9rem;">-</div>
                </div>
            </div>
            <div class="input-buttons">
                <button class="btn" onclick="saveVisit()">üíæ Speichern</button>
                <button class="btn btn-secondary" onclick="editVisit()">‚úèÔ∏è Bearbeiten</button>
                <button class="btn btn-secondary" onclick="resetForm()">üîÑ Nochmal</button>
            </div>
        </div>
        
        <div id="loading" class="loading">Lade Dashboard... üîÑ</div>
        
        <div id="dashboard" style="display:none;">
            <!-- Dashboard wird hier eingef√ºgt -->
        </div>
    </div>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxN7bBG1EqAckRcwpgGcEAuVmKe-oKqk36DRHsk29FfIZNkKQ0ALUB86KssnOdbxz-KhQ/exec';
        
        let allData = [];
        let filteredData = []; // Gefilterte Daten nach Zeitraum
        let parsedData = {};
        let recognition;
        let isListening = false;
        
        // Speech Recognition
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'de-DE';
            recognition.interimResults = true;
            
            recognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0].transcript)
                    .join('');
                
                document.getElementById('textInput').value = transcript;
                
                if (event.results[0].isFinal) {
                    analyzeText();
                    stopListening();
                }
            };
            
            recognition.onend = () => stopListening();
            recognition.onerror = (event) => {
                console.error('Speech error:', event.error);
                stopListening();
                alert('Spracherkennung fehlgeschlagen. Nutze die Texteingabe!');
            };
        }
        
        // Lade Daten beim Start
        window.addEventListener('load', loadData);
        
        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Laden fehlgeschlagen');
                
                allData = await response.json();
                
                console.log('Raw data loaded:', allData.length, 'rows');
                
                // Filtere Schwarzwild UND parse Datum richtig
                const schwarzwild = allData.filter(item => {
                    // Pr√ºfe wildart
                    if (!item.wildart) return false;
                    const wildartStr = item.wildart.toString().toLowerCase();
                    if (!wildartStr.includes('schwarzwild') && !wildartStr.includes('sau')) return false;
                    
                    // Pr√ºfe ob Datum vorhanden
                    if (!item.datum_nacht) return false;
                    
                    return true;
                }).map(item => {
                    // Parse Datum aus verschiedenen Formaten
                    let datum;
                    if (item.datum_nacht instanceof Date) {
                        datum = item.datum_nacht;
                    } else if (typeof item.datum_nacht === 'string') {
                        // Format: "2025-04-01" oder "01.04.2025"
                        if (item.datum_nacht.includes('-')) {
                            datum = new Date(item.datum_nacht);
                        } else if (item.datum_nacht.includes('.')) {
                            const parts = item.datum_nacht.split('.');
                            datum = new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                    } else if (typeof item.datum_nacht === 'number') {
                        // Excel Serial Date
                        datum = new Date((item.datum_nacht - 25569) * 86400 * 1000);
                    }
                    
                    // Tag/Nacht Korrektur: Besuche ab 18:00 Uhr geh√∂ren zur n√§chsten Nacht
                    if (item.uhrzeit_von) {
                        const uhrzeit = item.uhrzeit_von.toString();
                        const stunden = parseInt(uhrzeit.split(':')[0]);
                        
                        // Wenn nach 18:00 Uhr ‚Üí z√§hlt als n√§chster Tag
                        if (stunden >= 18) {
                            datum = new Date(datum);
                            datum.setDate(datum.getDate() + 1);
                        }
                    }
                    
                    return {
                        ...item,
                        datum_parsed: datum
                    };
                });
                
                console.log('Filtered Schwarzwild:', schwarzwild.length, 'entries');
                
                // Wende Zeitraum-Filter an
                applyZeitraumFilter(schwarzwild);
                
            } catch (error) {
                console.error('Load error:', error);
                document.getElementById('loading').innerHTML = 
                    `<div class="error">‚ùå Fehler beim Laden: ${error.message}</div>`;
            }
        }
        
        function applyZeitraumFilter(dataToFilter) {
            const zeitraum = document.getElementById('zeitraumFilter').value;
            const heute = new Date();
            heute.setHours(0, 0, 0, 0);
            
            let startDate = null;
            let zeitraumText = '';
            
            // Verwende entweder √ºbergebene Daten oder allData
            const sourceData = dataToFilter || allData;
            
            switch(zeitraum) {
                case 'all':
                    filteredData = sourceData;
                    zeitraumText = 'All Time';
                    break;
                case '12m':
                    startDate = new Date(heute);
                    startDate.setMonth(startDate.getMonth() - 12);
                    filteredData = sourceData.filter(d => d.datum_parsed >= startDate);
                    zeitraumText = 'Letzte 12 Monate';
                    break;
                case '3m':
                    startDate = new Date(heute);
                    startDate.setMonth(startDate.getMonth() - 3);
                    filteredData = sourceData.filter(d => d.datum_parsed >= startDate);
                    zeitraumText = 'Letzte 3 Monate';
                    break;
                case '1m':
                    startDate = new Date(heute);
                    startDate.setMonth(startDate.getMonth() - 1);
                    filteredData = sourceData.filter(d => d.datum_parsed >= startDate);
                    zeitraumText = 'Letzter Monat';
                    break;
            }
            
            console.log(`Filter: ${zeitraumText} ‚Üí ${filteredData.length} Besuche`);
            
            // Dashboard mit gefilterten Daten rendern
            renderDashboard(filteredData);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('dateInfo').textContent = 
                `${zeitraumText} ‚Ä¢ ${filteredData.length} Besuche`;
            
            // Warnung wenn zu wenig Daten
            if (filteredData.length < 5) {
                const warnung = document.createElement('div');
                warnung.className = 'error';
                warnung.style.margin = '1rem 0';
                warnung.innerHTML = `‚ö†Ô∏è Nur ${filteredData.length} Besuche im Zeitraum - Forecast m√∂glicherweise ungenau`;
                const dashboard = document.getElementById('dashboard');
                dashboard.insertBefore(warnung, dashboard.firstChild);
            }
        }
        
        function renderDashboard(data) {
            const kirrungen = [
                { name: 'S√§gem√ºhle', filter: ['s√§gm√ºhle', 's√§gem√ºhle', 'saegmuehle'] },
                { name: 'Horlacher', filter: ['horlacher'] },
                { name: 'Tiersbach', filter: ['tiersbach'] }
            ];
            const heute = new Date(); // ECHTES DATUM
            heute.setHours(0, 0, 0, 0);
            
            let html = '<div class="dashboard-grid">';
            
            kirrungen.forEach(k => {
                const kirrungData = data.filter(d => {
                    if (!d.ort) return false;
                    const ort = d.ort.toString().toLowerCase();
                    return k.filter.some(f => ort.includes(f));
                });
                
                console.log(`${k.name}: ${kirrungData.length} Besuche`);
                
                html += renderKirrungCard(k.name, kirrungData, heute);
            });
            
            html += '</div>';
            
            document.getElementById('dashboard').innerHTML = html;
        }
        
        function renderKirrungCard(name, data, heute) {
            // Sortiere nach Datum
            const sortedData = data.sort((a, b) => a.datum_parsed - b.datum_parsed);
            
            const letzterBesuch = sortedData.length > 0 ? sortedData[sortedData.length - 1].datum_parsed : null;
            const ersterBesuch = sortedData.length > 0 ? sortedData[0].datum_parsed : null;
            
            // Tage seit letztem Besuch (korrekt berechnet)
            let tageSeit = 999;
            if (letzterBesuch) {
                const letzterBesuchDate = new Date(letzterBesuch);
                letzterBesuchDate.setHours(0, 0, 0, 0);
                const heuteDate = new Date(heute);
                heuteDate.setHours(0, 0, 0, 0);
                tageSeit = Math.floor((heuteDate - letzterBesuchDate) / (1000 * 60 * 60 * 24));
            }
            
            // Baseline korrekt berechnen
            let baseline = '0';
            if (sortedData.length > 0 && ersterBesuch) {
                const ersterBesuchDate = new Date(ersterBesuch);
                ersterBesuchDate.setHours(0, 0, 0, 0);
                const heuteDate = new Date(heute);
                heuteDate.setHours(0, 0, 0, 0);
                const tageGesamt = Math.max(1, Math.floor((heuteDate - ersterBesuchDate) / (1000 * 60 * 60 * 24)));
                baseline = ((sortedData.length / tageGesamt) * 100).toFixed(1);
            }
            
            // Berechne Forecast
            const forecast = berechneForecast(name, sortedData, heute, tageSeit);
            
            // Berechne Wochentag-Statistik
            const wochentagStats = berechneWochentagStats(sortedData);
            
            // Berechne Uhrzeiten-Statistik
            const uhrzeitStats = berechneUhrzeitStats(sortedData);
            
            // Statistiken
            const maxChance = getMaxChance(name);
            
            let html = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">${name}</div>
                        <div class="badge">${sortedData.length} Besuche</div>
                    </div>
                    
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-label">Letzter Besuch</div>
                            <div class="stat-value">${letzterBesuch ? formatNachtDatum(letzterBesuch) : '-'}</div>
                            <div class="stat-sub">${tageSeit < 999 ? 'vor ' + tageSeit + ' Nacht' + (tageSeit !== 1 ? 'en' : '') : ''}</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Baseline</div>
                            <div class="stat-value">${baseline}%</div>
                            <div class="stat-sub">Max: ${maxChance}%</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <div class="stat-label">4-TAGE-FORECAST</div>
                        <div class="forecast-grid">
            `;
            
            forecast.forEach((day, index) => {
                const probClass = day.prob >= 20 ? 'high' : (day.prob >= 10 ? 'medium' : 'low');
                const label = index === 0 ? 'HEUTE' : (index === 1 ? 'MORGEN' : '');
                html += `
                    <div class="forecast-day ${probClass}-prob">
                        ${label ? `<div style="font-size: 0.65rem; font-weight: 600; color: var(--accent-green); margin-bottom: 0.3rem;">${label}</div>` : ''}
                        <div class="forecast-date">${day.nachtLabel}</div>
                        <div class="forecast-prob ${probClass}">${day.prob}%</div>
                        <div class="forecast-label" style="font-size: 0.65rem;">${day.label}</div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                        <div class="info-box" style="margin-top: 1rem;">
                            <div class="info-title">üí° Empfehlung</div>
                            <div class="info-text">${forecast[0].empfehlung}</div>
                        </div>
                    </div>
            `;
            
            // Wochentag-Statistik (ALLE Wochentage Mo-So)
            if (sortedData.length >= 3) {
                html += `
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                        <div class="stat-label">üìÖ WOCHENTAG-VERTEILUNG</div>
                `;
                const alleWochentage = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
                const wochentagMap = {};
                wochentagStats.forEach(s => { wochentagMap[s.tag] = s; });
                
                const maxPercent = Math.max(...wochentagStats.map(s => s.percent), 1);
                
                alleWochentage.forEach(tag => {
                    const stat = wochentagMap[tag] || { tag: tag, count: 0, percent: 0 };
                    const barWidth = Math.round((stat.percent / maxPercent) * 100);
                    const color = stat.percent === 0 ? 'rgba(255,255,255,0.1)' : 'var(--accent-green)';
                    html += `
                        <div style="margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.2rem;">
                                <span>${stat.tag}</span>
                                <span style="color: ${color};">${stat.percent}%</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: ${color}; height: 100%; width: ${barWidth}%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // Uhrzeiten-Statistik (NUR 20:00-06:00)
            if (sortedData.length >= 3) {
                html += `
                    <div style="margin-top: 1.5rem;">
                        <div class="stat-label">üïê UHRZEITEN 20:00-06:00</div>
                `;
                const jagdStunden = [20, 21, 22, 23, 0, 1, 2, 3, 4, 5];
                const uhrzeitMap = {};
                uhrzeitStats.forEach(s => {
                    const stunde = parseInt(s.zeit.split(':')[0]);
                    uhrzeitMap[stunde] = s;
                });
                
                const maxPercent = Math.max(
                    ...jagdStunden.map(h => (uhrzeitMap[h] || {}).percent || 0),
                    1
                );
                
                jagdStunden.forEach(stunde => {
                    const stat = uhrzeitMap[stunde] || { 
                        zeit: `${stunde.toString().padStart(2, '0')}:00-${((stunde+1)%24).toString().padStart(2, '0')}:00`,
                        count: 0,
                        percent: 0
                    };
                    const barWidth = Math.round((stat.percent / maxPercent) * 100);
                    const color = stat.percent === 0 ? 'rgba(255,255,255,0.1)' : 'var(--accent-orange)';
                    html += `
                        <div style="margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 0.2rem;">
                                <span>${stat.zeit}</span>
                                <span style="color: ${color};">${stat.percent}%</span>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); height: 6px; border-radius: 3px; overflow: hidden;">
                                <div style="background: ${color}; height: 100%; width: ${barWidth}%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            
            return html;
        }
        
        function berechneWochentagStats(data) {
            const wochentage = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            const counts = [0, 0, 0, 0, 0, 0, 0];
            
            data.forEach(item => {
                if (item.datum_parsed) {
                    const tag = item.datum_parsed.getDay();
                    const index = tag === 0 ? 6 : tag - 1; // Sonntag = 0 ‚Üí Index 6
                    counts[index]++;
                }
            });
            
            const total = data.length;
            const stats = wochentage.map((tag, i) => ({
                tag: tag,
                count: counts[i],
                percent: total > 0 ? Math.round((counts[i] / total) * 100) : 0
            }));
            
            return stats.filter(s => s.count > 0).sort((a, b) => b.count - a.count);
        }
        
        function berechneUhrzeitStats(data) {
            const stundenCounts = Array(24).fill(0);
            
            data.forEach(item => {
                if (item.uhrzeit_von) {
                    const uhrzeit = item.uhrzeit_von.toString();
                    const match = uhrzeit.match(/(\d{1,2})/);
                    if (match) {
                        const stunde = parseInt(match[1]);
                        if (stunde >= 0 && stunde < 24) {
                            stundenCounts[stunde]++;
                        }
                    }
                }
            });
            
            const total = data.length;
            const stats = stundenCounts.map((count, stunde) => ({
                zeit: `${stunde.toString().padStart(2, '0')}:00-${((stunde+1)%24).toString().padStart(2, '0')}:00`,
                count: count,
                percent: total > 0 ? Math.round((count / total) * 100) : 0
            }));
            
            return stats.filter(s => s.count > 0).sort((a, b) => b.count - a.count);
        }
        
        function berechneForecast(kirrung, data, heute, tageSeit) {
            const forecast = [];
            const wochentage = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            
            // Berechne Wochentag-Verteilung aus den AKTUELLEN Daten (nicht hardcoded!)
            const wochentagCounts = [0,0,0,0,0,0,0];
            data.forEach(item => {
                if (item.datum_parsed) {
                    wochentagCounts[item.datum_parsed.getDay()]++;
                }
            });
            const totalCount = data.length || 1;
            const wochentagProzent = wochentagCounts.map(c => (c / totalCount) * 100);
            
            // Finde beste 2 Wochentage
            const sortedWochentage = wochentagProzent
                .map((p, i) => ({ tag: wochentage[i], prozent: p, index: i }))
                .sort((a, b) => b.prozent - a.prozent);
            const besteWochentage = [sortedWochentage[0].tag, sortedWochentage[1].tag];
            
            console.log(`${kirrung} - Beste Wochentage: ${besteWochentage[0]} (${sortedWochentage[0].prozent.toFixed(1)}%), ${besteWochentage[1]} (${sortedWochentage[1].prozent.toFixed(1)}%)`);
            
            for (let i = 0; i < 4; i++) {
                const tag = new Date(heute);
                tag.setDate(tag.getDate() + i);
                
                const morgen = new Date(tag);
                morgen.setDate(morgen.getDate() + 1);
                
                const wochentagHeute = wochentage[tag.getDay()];
                const wochentagMorgen = wochentage[morgen.getDay()];
                const tageSeither = tageSeit + i;
                
                // Nacht-Label: "Do/Fr 06./07.02"
                const nachtLabel = `${wochentagHeute}/${wochentagMorgen} ${tag.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'})}./${morgen.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'})}.`;
                
                // Wahrscheinlichkeitsberechnung
                let prob = 5; // Basis
                
                // Intervall-Faktor
                if (tageSeither === 1) prob += 20; // Folgenacht
                else if (tageSeither <= 3) prob += 10;
                else if (tageSeither <= 7) prob += 5;
                
                // Wochentag-Faktor (dynamisch aus Daten!)
                if (besteWochentage.includes(wochentagHeute)) {
                    prob += 5;
                }
                
                prob = Math.min(prob, 35); // Cap bei 35%
                
                let label = '';
                if (tageSeither === 1) label = 'Folgenacht!';
                else if (tageSeither <= 3) label = tageSeither + ' N√§chte Pause';
                else label = tageSeither + ' N√§chte Pause';
                
                forecast.push({
                    nachtLabel: nachtLabel,
                    prob: prob,
                    label: label,
                    empfehlung: i === 0 ? getEmpfehlung(kirrung, prob, tageSeither, wochentagHeute) : ''
                });
            }
            
            return forecast;
        }
        
        // Hilfsfunktion: Formatiere Datum als "Nacht Do/Fr 06./07.02"
        function formatNachtDatum(datum) {
            const wochentage = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            const morgen = new Date(datum);
            morgen.setDate(morgen.getDate() + 1);
            
            const wochentagHeute = wochentage[datum.getDay()];
            const wochentagMorgen = wochentage[morgen.getDay()];
            
            return `${wochentagHeute}/${wochentagMorgen} ${datum.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'})}./${morgen.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit'})}.`;
        }
        
        function getEmpfehlung(kirrung, prob, tage, wochentag) {
            if (tage === 1) {
                return `Folgenacht! ${prob}% Chance (beste Option). ${wochentag} ist g√ºnstig.`;
            } else if (tage <= 3) {
                return `${tage} Tage Pause - mittlere Aktivit√§t (${prob}%). ${wochentag} beachten.`;
            } else if (tage <= 7) {
                return `${tage} Tage Pause - niedrige Aktivit√§t (${prob}%). Kirrung pr√ºfen.`;
            } else {
                return `Lange Pause (${tage} Tage) - sehr niedrige Aktivit√§t. Kirrung auffrischen empfohlen.`;
            }
        }
        
        function getMaxChance(kirrung) {
            if (kirrung === 'S√§gem√ºhle') return '28';
            if (kirrung === 'Horlacher') return '23';
            return '25';
        }
        
        // === EINGABE-FUNKTIONEN ===
        
        function toggleListening() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }
        
        function startListening() {
            if (!recognition) {
                alert('Spracherkennung wird von deinem Browser nicht unterst√ºtzt. Nutze Chrome oder Safari!');
                return;
            }
            
            isListening = true;
            document.getElementById('micButton').classList.add('listening');
            recognition.start();
        }
        
        function stopListening() {
            isListening = false;
            if (document.getElementById('micButton')) {
                document.getElementById('micButton').classList.remove('listening');
            }
        }
        
        function analyzeText() {
            const text = document.getElementById('textInput').value.trim();
            
            if (!text) {
                alert('Bitte Text eingeben!');
                return;
            }
            
            parseTranscript(text);
        }
        
        function parseTranscript(text) {
            const lower = text.toLowerCase();
            
            // Datum
            let datum = new Date();
            if (lower.includes('gestern')) {
                datum.setDate(datum.getDate() - 1);
            } else if (lower.includes('vorgestern')) {
                datum.setDate(datum.getDate() - 2);
            } else if (lower.includes('heute')) {
                // J√ÑGER-LOGIK: "heute waren Sauen da" = Nacht von gestern auf heute
                if (lower.includes('waren') || lower.includes('war') || lower.includes('besuch')) {
                    datum.setDate(datum.getDate() - 1);
                }
                // Sonst bleibt heute (f√ºr zuk√ºnftige Ansitz-Planung)
            }
            
            // Uhrzeit von-bis
            let uhrzeitVon = '';
            let uhrzeitBis = '';
            
            const vonBisMatch = lower.match(/von\s+(\d{1,2})[:\s]?(\d{2})?\s*(uhr)?\s+bis\s+(\d{1,2})[:\s]?(\d{2})?/i);
            if (vonBisMatch) {
                uhrzeitVon = `${vonBisMatch[1].padStart(2, '0')}:${(vonBisMatch[2] || '00').padStart(2, '0')}`;
                uhrzeitBis = `${vonBisMatch[4].padStart(2, '0')}:${(vonBisMatch[5] || '00').padStart(2, '0')}`;
            } else {
                // Einzelne Zeiten
                const zeiten = text.match(/(\d{1,2})[:\s](\d{2})/g);
                if (zeiten && zeiten.length > 0) {
                    uhrzeitVon = zeiten[0].replace(/\s/g, ':').replace(/^(\d):/, '0$1:');
                    if (zeiten.length > 1) {
                        uhrzeitBis = zeiten[1].replace(/\s/g, ':').replace(/^(\d):/, '0$1:');
                    }
                }
            }
            
            // Kirrung
            let kirrung = '';
            if (lower.includes('s√§g') || lower.includes('saeg')) kirrung = 'S√§gem√ºhle';
            else if (lower.includes('horlach')) kirrung = 'Horlacher';
            else if (lower.includes('tiers')) kirrung = 'Tiersbach';
            
            // Anzahl
            let anzahl = '';
            const anzahlMatch = text.match(/(\d+|eine?|zwei|drei|vier|f√ºnf|sechs|sieben|acht|neun|zehn)\s*(starke?|gro√üe?)?\s*(bache|bachen|sau|sauen|√ºberl√§ufer|frischling)/gi);
            if (anzahlMatch) {
                anzahl = anzahlMatch.map(m => m.trim()).join(', ');
            }
            
            // Notizen
            let notizen = '';
            if (lower.includes('anwechsel')) {
                const anwechselMatch = text.match(/anwechsel[^\.,]*/i);
                if (anwechselMatch) notizen += anwechselMatch[0] + '. ';
            }
            if (lower.includes('s√ºd') || lower.includes('nord') || lower.includes('ost') || lower.includes('west')) {
                const richtungMatch = text.match(/(s√ºd|nord|ost|west)[a-z√§√∂√º]*/gi);
                if (richtungMatch) notizen += 'Richtung: ' + richtungMatch.join(', ') + '. ';
            }
            
            parsedData = {
                datum: datum,
                uhrzeitVon: uhrzeitVon,
                uhrzeitBis: uhrzeitBis,
                kirrung: kirrung,
                anzahl: anzahl,
                notizen: notizen.trim()
            };
            
            showPreview();
        }
        
        function showPreview() {
            document.getElementById('previewDatum').textContent = 
                parsedData.datum ? parsedData.datum.toLocaleDateString('de-DE') : '-';
            document.getElementById('previewUhrzeitVon').textContent = parsedData.uhrzeitVon || '-';
            document.getElementById('previewUhrzeitBis').textContent = parsedData.uhrzeitBis || '-';
            document.getElementById('previewKirrung').textContent = parsedData.kirrung || '-';
            document.getElementById('previewAnzahl').textContent = parsedData.anzahl || '-';
            document.getElementById('previewNotizen').textContent = parsedData.notizen || '-';
            
            document.getElementById('previewCard').classList.add('active');
        }
        
        function editVisit() {
            const datum = prompt('Datum (TT.MM.JJJJ):', parsedData.datum ? parsedData.datum.toLocaleDateString('de-DE') : '');
            const uhrzeitVon = prompt('Uhrzeit Von (HH:MM):', parsedData.uhrzeitVon || '');
            const uhrzeitBis = prompt('Uhrzeit Bis (HH:MM):', parsedData.uhrzeitBis || '');
            const kirrung = prompt('Kirrung:', parsedData.kirrung || '');
            const anzahl = prompt('Anzahl:', parsedData.anzahl || '');
            const notizen = prompt('Notizen:', parsedData.notizen || '');
            
            if (datum) {
                const parts = datum.split('.');
                parsedData.datum = new Date(parts[2], parts[1]-1, parts[0]);
            }
            if (uhrzeitVon !== null) parsedData.uhrzeitVon = uhrzeitVon;
            if (uhrzeitBis !== null) parsedData.uhrzeitBis = uhrzeitBis;
            if (kirrung) parsedData.kirrung = kirrung;
            if (anzahl) parsedData.anzahl = anzahl;
            if (notizen !== null) parsedData.notizen = notizen;
            
            showPreview();
        }
        
        async function saveVisit() {
            if (!parsedData.datum || !parsedData.kirrung) {
                alert('Bitte mindestens Datum und Kirrung angeben!');
                return;
            }
            
            const formData = {
                datum_nacht: parsedData.datum.toISOString().split('T')[0],
                uhrzeit_von: parsedData.uhrzeitVon || '',
                uhrzeit_bis: parsedData.uhrzeitBis || '',
                ort: parsedData.kirrung,
                anzahl: parsedData.anzahl || '',
                sonstiges: parsedData.notizen || ''
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) throw new Error('Speichern fehlgeschlagen');
                
                document.getElementById('successMessage').classList.add('active');
                document.getElementById('previewCard').classList.remove('active');
                document.getElementById('textInput').value = '';
                
                setTimeout(() => {
                    document.getElementById('successMessage').classList.remove('active');
                    loadData(); // Reload dashboard
                }, 2000);
                
                parsedData = {};
                
            } catch (error) {
                alert('‚ùå Fehler beim Speichern: ' + error.message);
            }
        }
        
        function resetForm() {
            parsedData = {};
            document.getElementById('previewCard').classList.remove('active');
            document.getElementById('textInput').value = '';
        }
    </script>
</body>
</html>
