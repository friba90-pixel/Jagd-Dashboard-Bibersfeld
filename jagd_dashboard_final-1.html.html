<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schwarzwild Dashboard v1.2.4 - FINAL FIX</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #2a4a2a 0%, #1a3a1a 100%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; color: #fff; }
        .header-info { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; align-items: center; }
        select, .btn-reload {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
        }
        .btn-reload { background: #4CAF50; font-weight: 600; }
        .btn-reload:hover { background: #45a049; }
        
        /* Eingabe */
        .input-section { background: #2d2d2d; padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        .input-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #444; }
        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1em;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active { color: #4CAF50; border-bottom-color: #4CAF50; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.95em; }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            font-family: inherit;
        }
        .input-group textarea { min-height: 60px; resize: vertical; }
        .checkbox-group { display: flex; gap: 20px; flex-wrap: wrap; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .submit-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        .submit-btn:hover { transform: translateY(-2px); }
        
        /* Review Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background: #2d2d2d;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }
        .modal-header {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #4CAF50;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
        }
        .review-field {
            margin-bottom: 15px;
            padding: 12px;
            background: #1a1a1a;
            border-radius: 8px;
        }
        .review-label { color: #999; font-size: 0.9em; margin-bottom: 5px; }
        .review-value {
            color: #fff;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .review-value input, .review-value select {
            flex: 1;
            padding: 8px;
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 5px;
            color: #fff;
        }
        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: flex-end;
        }
        .btn-cancel, .btn-save {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
        }
        .btn-cancel { background: #666; color: #fff; }
        .btn-save { background: linear-gradient(135deg, #4CAF50, #45a049); color: #fff; }
        
        /* Kirrungen */
        .kirrungen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .kirrung-card { background: #2d2d2d; padding: 25px; border-radius: 15px; }
        .kirrung-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .kirrung-title { font-size: 1.5em; color: #fff; }
        .ampel {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }
        .ampel.gruen { background: #4CAF50; box-shadow: 0 0 20px rgba(76, 175, 80, 0.6); }
        .ampel.rot { background: #f44336; box-shadow: 0 0 20px rgba(244, 67, 54, 0.6); }
        .kirr-status {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.95em;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #444;
        }
        .stat-label { color: #999; }
        .stat-value { color: #fff; font-weight: 600; }
        
        /* Statistiken in Kirrung */
        .kirrung-stats {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .stat-box {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
        }
        .stat-box h4 { 
            font-size: 0.9em;
            color: #4CAF50;
            margin-bottom: 10px;
        }
        .stat-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-size: 0.85em;
        }
        .stat-bar-label { width: 30px; color: #999; }
        .stat-bar-fill {
            height: 18px;
            background: #4CAF50;
            border-radius: 3px;
            padding: 0 5px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            color: #fff;
        }
        
        /* Forecast */
        .forecast-section { margin-top: 20px; }
        .forecast-title { font-size: 1.1em; margin-bottom: 15px; color: #4CAF50; }
        .forecast-day {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .forecast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .forecast-date { font-weight: 600; }
        .forecast-prob {
            font-size: 1.5em;
            font-weight: 700;
        }
        .forecast-prob.high { color: #4CAF50; }
        .forecast-prob.medium { color: #FFC107; }
        .forecast-prob.low { color: #f44336; }
        .forecast-details {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            font-size: 0.9em;
            color: #999;
        }
        .forecast-detail { display: flex; align-items: center; gap: 5px; }
        
        /* Wind-Korrelation */
        .wind-korrelation {
            background: #2d2d2d;
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
        }
        .wind-korrelation h2 { margin-bottom: 20px; color: #fff; }
        .wind-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        .wind-kirrung h3 { margin-bottom: 15px; color: #4CAF50; }
        .wind-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .wind-label {
            width: 40px;
            text-align: right;
            color: #999;
            font-weight: 600;
        }
        .wind-bar-container {
            flex: 1;
            height: 28px;
            background: #1a1a1a;
            border-radius: 5px;
            overflow: hidden;
        }
        .wind-bar-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: #fff;
            font-size: 0.9em;
            font-weight: 600;
        }
        .wind-bar-fill.positive { background: linear-gradient(90deg, #4CAF50 0%, #66BB6A 100%); }
        .wind-bar-fill.negative { background: linear-gradient(90deg, #f44336 0%, #EF5350 100%); }
        .wind-bar-fill.neutral { background: #666; }
        
        #loading { text-align: center; padding: 50px; font-size: 1.2em; }
        
        @media (max-width: 768px) {
            .kirrungen-grid, .wind-grid {
                grid-template-columns: 1fr;
            }
            .kirrung-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêó Schwarzwild Dashboard v1.2.4 - FINAL</h1>
            <div class="header-info">
                <span id="currentDate"></span>
                <select id="zeitraumFilter">
                    <option value="all">Alle Daten</option>
                    <option value="12m">Letzte 12 Monate</option>
                    <option value="3m" selected>Letzte 3 Monate</option>
                    <option value="1m">Letzter Monat</option>
                </select>
                <button class="btn-reload" onclick="loadData()">üîÑ Aktualisieren</button>
                <span id="totalVisits">L√§dt...</span>
            </div>
        </div>
        
        <div id="loading">‚è≥ Lade Daten...</div>
        
        <div id="mainContent" style="display: none;">
            <!-- Eingabe Sektion -->
            <div class="input-section">
                <div class="input-tabs">
                    <button class="tab-button active" onclick="switchTab('besuch')">üêó Schwarzwild-Besuch</button>
                    <button class="tab-button" onclick="switchTab('kirr')">üåΩ Kirrung best√ºckt</button>
                </div>
                
                <div id="besuchTab" class="tab-content active">
                    <div class="input-group">
                        <label>üìù Nat√ºrliche Eingabe (wird automatisch erkannt)</label>
                        <input type="text" id="textInput" placeholder="Heute Nacht 3 Sauen S√§gm√ºhle von 21:30 bis 22:15">
                    </div>
                    <button class="submit-btn" onclick="parseAndReview()">üîç Eingabe pr√ºfen</button>
                </div>
                
                <div id="kirrTab" class="tab-content">
                    <div class="input-group">
                        <label>üìÖ Datum</label>
                        <input type="date" id="kirrDatum">
                    </div>
                    <div class="input-group">
                        <label>üåΩ Welche Kirrungen best√ºckt?</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="kirr_saegemuehle">
                                <label for="kirr_saegemuehle">S√§gm√ºhle</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="kirr_horlacher">
                                <label for="kirr_horlacher">Horlacher</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="kirr_tiersbach">
                                <label for="kirr_tiersbach">Tiersbach</label>
                            </div>
                        </div>
                    </div>
                    <button class="submit-btn" onclick="submitKirrung()">üíæ Best√ºckung speichern</button>
                </div>
            </div>
            
            <!-- Kirrungen -->
            <div class="kirrungen-grid" id="kirrungen"></div>
            
            <!-- Wind-Korrelation -->
            <div class="wind-korrelation">
                <h2>üí® Windrichtungs-Abh√§ngigkeit (Likelihood Ratios)</h2>
                <p style="color: #999; margin-bottom: 20px;">P(Wind|Besuch) / P(Wind|Baseline) ¬∑ 4 Hauptrichtungen (N, S, O, W)</p>
                <div class="wind-grid" id="windKorrelation"></div>
            </div>
        </div>
        
        <!-- Review Modal -->
        <div id="reviewModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">üìã Eingabe √ºberpr√ºfen</div>
                <div id="reviewFields"></div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeReview()">‚ùå Abbrechen</button>
                    <button class="btn-save" onclick="saveFromReview()">üíæ Speichern</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzIc0_KrKcJLSEdX895r7v2ooMTuVEgVrD-7TKRH9Cm79h9sRJ2xxMi-7w9dUVuysV8Zg/exec';
        
        let allData = [], filteredData = [], wetterBaseline = [], kirrbest√ºckungen = [];
        let reviewedData = null;
        
        // ========================================
        // INIT
        // ========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentDate').textContent = formatDatum(new Date());
            document.getElementById('kirrDatum').valueAsDate = new Date();
            document.getElementById('zeitraumFilter').addEventListener('change', () => applyZeitraumFilter(allData));
            loadData();
        });
        
        // ========================================
        // DATEN LADEN
        // ========================================
        
        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            
            try {
                const response = await fetch(API_URL);
                const json = await response.json();
                
                if (!json.success) throw new Error(json.error);
                
                allData = (json.data || []).map(parseBesuch);
                wetterBaseline = json.wetter_baseline || [];
                
                console.log('‚úÖ Geladen:', allData.length, 'Eintr√§ge');
                console.log('‚úÖ Wetter-Baseline:', wetterBaseline.length, 'Tage');
                
                applyZeitraumFilter(allData);
            } catch (error) {
                console.error('Fehler:', error);
                document.getElementById('loading').innerHTML = `<div style="color:#f44336">‚ùå ${error.message}</div>`;
            }
        }
        
        function parseBesuch(item) {
            let datum = item.datum_nacht;
            
            if (!datum) return { ...item, datum_parsed: null };
            
            if (typeof datum === 'string') {
                datum = new Date(datum);
            } else if (typeof datum === 'number') {
                datum = new Date((datum - 25569) * 86400000);
            } else if (!(datum instanceof Date)) {
                return { ...item, datum_parsed: null };
            }
            
            if (isNaN(datum.getTime())) {
                return { ...item, datum_parsed: null };
            }
            
            return { ...item, datum_parsed: datum };
        }
        
        // ========================================
        // FILTER
        // ========================================
        
        function applyZeitraumFilter(sourceData) {
            const zeitraum = document.getElementById('zeitraumFilter').value;
            const heute = new Date();
            let startDate = new Date(0);
            let zeitraumTage = 90;
            
            if (zeitraum === '1m') {
                startDate = new Date(heute);
                startDate.setMonth(startDate.getMonth() - 1);
                zeitraumTage = 30;
            } else if (zeitraum === '3m') {
                startDate = new Date(heute);
                startDate.setMonth(startDate.getMonth() - 3);
                zeitraumTage = 90;
            } else if (zeitraum === '12m') {
                startDate = new Date(heute);
                startDate.setMonth(startDate.getMonth() - 12);
                zeitraumTage = 365;
            } else {
                zeitraumTage = 365;
            }
            
            const mitDatum = sourceData.filter(d => d.datum_parsed);
            
            // F√ºr Statistik: ALLE Besuche (ungefiltert)
            const alleBesuche = mitDatum.filter(d => d.art === 'Kirrbesuch');
            
            // F√ºr Anzeige: Gefilterte Besuche
            const besuche = mitDatum.filter(d => d.datum_parsed >= startDate && d.art === 'Kirrbesuch');
            
            // ALLE Best√ºckungen (f√ºr Ampel!)
            kirrbest√ºckungen = mitDatum.filter(d => d.art === 'Kirrbest√ºckung');
            
            filteredData = besuche;
            
            renderDashboard(alleBesuche, zeitraumTage);
        }
        
        // ========================================
        // DASHBOARD RENDERN
        // ========================================
        
        function renderDashboard(alleBesuche, zeitraumTage) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('totalVisits').textContent = `${filteredData.length} Besuche (angezeigt)`;
            
            renderKirrungen(alleBesuche, zeitraumTage);
            renderWindKorrelation(alleBesuche, zeitraumTage);
        }
        
        // ========================================
        // KIRRUNGEN RENDERN
        // ========================================
        
        function renderKirrungen(alleBesuche, zeitraumTage) {
            const kirrungen = ['S√§gm√ºhle', 'Horlacher', 'Tiersbach'];
            document.getElementById('kirrungen').innerHTML = kirrungen.map(k => {
                const data = alleBesuche.filter(d => d.ort && d.ort.includes(k.substring(0,4)));
                return createKirrungCard(k, data, alleBesuche, zeitraumTage);
            }).join('');
        }
        
        function createKirrungCard(kirrung, kirrungData, alleBesuche, zeitraumTage) {
            const stats = calculateKirrungStats(kirrungData);
            const forecast = calculateSmartForecast(kirrung, alleBesuche, zeitraumTage);
            const status = getKirrStatus(kirrung, kirrungData);
            const wochentagStats = calculateWochentagStats(kirrungData);
            const uhrzeitStats = calculateUhrzeitStats(kirrungData);
            
            // Random-Faktor berechnen
            const hotZoneCount = berechneHotZoneBesuche(kirrungData);
            const normalBesuche = kirrungData.length - hotZoneCount;
            const randomFaktor = (normalBesuche / zeitraumTage * 100).toFixed(1);
            
            return `
                <div class="kirrung-card">
                    <div class="kirrung-header">
                        <div class="kirrung-title">${kirrung}</div>
                        <div class="ampel ${status.ampel}">${status.icon}</div>
                    </div>
                    <div class="kirr-status">${status.text}</div>
                    <div class="stat-row">
                        <span class="stat-label">Gesamt-Besuche</span>
                        <span class="stat-value">${kirrungData.length}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Letzter Besuch</span>
                        <span class="stat-value">${stats.letzter}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Letzte Best√ºckung</span>
                        <span class="stat-value">${status.letzteKirr}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Random-Faktor</span>
                        <span class="stat-value">${randomFaktor}% / Tag</span>
                    </div>
                    
                    <div class="kirrung-stats">
                        <div class="stat-box">
                            <h4>üìÖ Wochentage</h4>
                            ${wochentagStats}
                        </div>
                        <div class="stat-box">
                            <h4>üïê Uhrzeiten (18-07h)</h4>
                            ${uhrzeitStats}
                        </div>
                    </div>
                    
                    <div class="forecast-section">
                        <div class="forecast-title">üìä 4-N√§chte Smart Forecast</div>
                        ${forecast.map(f => `
                            <div class="forecast-day">
                                <div class="forecast-header">
                                    <div class="forecast-date">${f.label}</div>
                                    <div class="forecast-prob ${f.klasse}">${f.prob}%</div>
                                </div>
                                <div class="forecast-details">
                                    <div class="forecast-detail">üí® ${f.wind}</div>
                                    <div class="forecast-detail">${f.hinweis}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function calculateKirrungStats(data) {
            // Nur Besuche MIT Uhrzeit!
            const mitUhrzeit = data.filter(d => d.uhrzeit_von);
            
            if (mitUhrzeit.length === 0) return { letzter: 'Keine Daten' };
            
            // WICHTIG: Nutze Nacht-Datum, nicht Raw-Datum!
            const neuester = mitUhrzeit.reduce((max, d) => {
                const nachtDatum = getNachtDatum(d.datum_parsed, d.uhrzeit_von);
                return nachtDatum > max ? nachtDatum : max;
            }, getNachtDatum(mitUhrzeit[0].datum_parsed, mitUhrzeit[0].uhrzeit_von));
            
            const tage = Math.floor((new Date() - neuester) / 86400000);
            
            return { letzter: tage === 0 ? 'Heute' : `vor ${tage} Tag${tage === 1 ? '' : 'en'}` };
        }
        
        function calculateWochentagStats(data) {
            const tage = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            const counts = [0,0,0,0,0,0,0];
            
            data.forEach(d => {
                if (d.datum_parsed) {
                    const idx = (d.datum_parsed.getDay() + 6) % 7; // Mo=0
                    counts[idx]++;
                }
            });
            
            const max = Math.max(...counts, 1);
            return tage.map((t, i) => {
                const width = (counts[i] / max) * 100;
                return `
                    <div class="stat-bar">
                        <div class="stat-bar-label">${t}</div>
                        <div class="stat-bar-fill" style="width: ${width}%">${counts[i]}</div>
                    </div>
                `;
            }).join('');
        }
        
        function calculateUhrzeitStats(data) {
            const counts = {};
            
            data.forEach(d => {
                if (d.uhrzeit_von) {
                    const h = parseInt(d.uhrzeit_von.toString().split(':')[0]);
                    if (!isNaN(h)) {
                        counts[h] = (counts[h] || 0) + 1;
                    }
                }
            });
            
            // 18-07 Uhr (Nacht-Definition!)
            const hours = [18,19,20,21,22,23,0,1,2,3,4,5,6,7];
            const max = Math.max(...Object.values(counts), 1);
            
            return hours.map(h => {
                const c = counts[h] || 0;
                const width = (c / max) * 100;
                const label = h.toString().padStart(2, '0') + 'h';
                return `
                    <div class="stat-bar">
                        <div class="stat-bar-label">${label}</div>
                        <div class="stat-bar-fill" style="width: ${width}%">${c}</div>
                    </div>
                `;
            }).join('');
        }
        
        function getKirrStatus(kirrung, kirrungData) {
            const heute = new Date();
            
            const alleKirrungen = kirrbest√ºckungen.filter(k => k.ort && k.ort.includes(kirrung));
            const letzteKirr = alleKirrungen.sort((a,b) => b.datum_parsed - a.datum_parsed)[0];
            
            if (!letzteKirr) {
                return { 
                    ampel: 'rot', 
                    icon: 'üî¥', 
                    text: '‚ö†Ô∏è Noch nie best√ºckt',
                    letzteKirr: 'Nie' 
                };
            }
            
            const tageSeitKirr = Math.floor((heute - letzteKirr.datum_parsed) / 86400000);
            const besucheSeit = kirrungData.filter(d => d.datum_parsed > letzteKirr.datum_parsed);
            const letzteKirrText = tageSeitKirr === 0 ? 'Heute' : `vor ${tageSeitKirr} Tag${tageSeitKirr === 1 ? '' : 'en'}`;
            
            if (besucheSeit.length > 0) {
                return { 
                    ampel: 'rot', 
                    icon: 'üî¥', 
                    text: `üêó ${besucheSeit.length} Besuch(e) seit ${letzteKirrText} ‚Üí Nachkirren!`,
                    letzteKirr: letzteKirrText
                };
            } else if (tageSeitKirr > 10) {
                return { 
                    ampel: 'rot', 
                    icon: 'üî¥', 
                    text: `‚è∞ ${tageSeitKirr} Tage ohne Best√ºckung ‚Üí Best√ºcken!`,
                    letzteKirr: letzteKirrText
                };
            } else {
                return { 
                    ampel: 'gruen', 
                    icon: 'üü¢', 
                    text: `‚úÖ Best√ºckt ${letzteKirrText} ¬∑ Keine Besuche`,
                    letzteKirr: letzteKirrText
                };
            }
        }
        
        // ========================================
        // NACHT-DATUM NORMALISIERUNG (v1.2.2 FIX!)
        // ========================================
        
        function parseStunde(uhrzeit) {
            if (!uhrzeit) return null;
            
            const str = uhrzeit.toString();
            
            // Excel-Zeitstempel: "1899-12-30T08:24:00.000Z"
            if (str.includes('T')) {
                const timePart = str.split('T')[1]; // "08:24:00.000Z"
                const stunde = parseInt(timePart.split(':')[0]);
                return isNaN(stunde) ? null : stunde;
            }
            
            // Normal: "01:30" oder "1:30"
            const stunde = parseInt(str.split(':')[0]);
            return isNaN(stunde) ? null : stunde;
        }
        
        function getNachtDatum(besuchDatum, uhrzeit) {
            const d = new Date(besuchDatum);
            
            // KRITISCH: Setze Uhrzeit auf Mitternacht!
            d.setHours(0, 0, 0, 0);
            
            // Wenn Uhrzeit vor 18:00 ‚Üí Besuch war in der Nacht die GESTERN begann
            if (uhrzeit) {
                const stunde = parseStunde(uhrzeit);
                if (stunde !== null && stunde < 18) {
                    d.setDate(d.getDate() - 1);
                }
            }
            
            return d;
        }
        
        // ========================================
        // SMART FORECAST (v1.2.2 mit Excel-Fix!)
        // ========================================
        
        function calculateSmartForecast(kirrung, alleBesuche, zeitraumTage) {
            // Nur Besuche MIT Uhrzeit nutzen!
            const kirrungData = alleBesuche.filter(d => 
                d.ort && d.ort.includes(kirrung) && d.uhrzeit_von
            );
            
            if (kirrungData.length < 3) {
                return [{label: 'Zu wenig Daten', prob: 0, klasse: 'low', wind: '-', hinweis: 'Min. 3 Besuche n√∂tig'}];
            }
            
            const forecast = [];
            
            // Random-Faktor
            const hotZoneCount = berechneHotZoneBesuche(kirrungData);
            const normalBesuche = kirrungData.length - hotZoneCount;
            const randomFaktor = normalBesuche / zeitraumTage;
            
            const durchschnitt = berechneDurchschnittIntervall(kirrungData);
            
            // WICHTIG: Letzten Besuch auf Nacht-Datum normalisieren!
            let letzterBesuch = null;
            if (kirrungData.length > 0) {
                const neuesterBesuch = kirrungData.reduce((max, d) => 
                    d.datum_parsed > max.datum_parsed ? d : max, 
                    kirrungData[0]
                );
                letzterBesuch = getNachtDatum(neuesterBesuch.datum_parsed, neuesterBesuch.uhrzeit_von);
            }
            
            const windLikelihood = calculateWindLikelihood(kirrungData, zeitraumTage);
            
            for (let i = 0; i < 4; i++) {
                const datum = new Date();
                datum.setDate(datum.getDate() + i);
                
                // NACHT-NOTATION: 8./9.2. (Sa/So)
                const datum2 = new Date(datum);
                datum2.setDate(datum2.getDate() + 1);
                
                const tag1 = ['So','Mo','Di','Mi','Do','Fr','Sa'][datum.getDay()];
                const tag2 = ['So','Mo','Di','Mi','Do','Fr','Sa'][datum2.getDay()];
                
                const label = `NACHT ${datum.getDate()}./${datum2.getDate()}.${datum2.getMonth()+1}. (${tag1}/${tag2})`;
                
                const mockWind = ['S', 'O', 'W', 'N'][i];
                
                // WICHTIG: Vergleiche N√ÑCHTE, nicht Tage!
                // Forecast-Nacht = Nacht die heute Abend beginnt = datum (ohne Zeit)
                const forecastNacht = new Date(datum);
                forecastNacht.setHours(0, 0, 0, 0);
                
                // Tage seit letztem Besuch (in N√ÑCHTEN!)
                const tageSeit = letzterBesuch ? Math.floor((forecastNacht - letzterBesuch) / 86400000) : 999;
                const relativ = tageSeit / durchschnitt;
                
                // RHYTHMUS-FAKTOR
                const rhythmusFaktor = berechneRhythmusFaktor(tageSeit, durchschnitt);
                
                let prob;
                
                if (relativ > 2.0) {
                    // VERGESSEN - nutze Random-Faktor!
                    prob = randomFaktor * 100;
                } else {
                    // IN ROUTINE
                    const basisRate = kirrungData.length / zeitraumTage;
                    prob = basisRate * rhythmusFaktor * 100;
                }
                
                // Wind-Faktor (OHNE Wochentag!)
                const windFaktor = windLikelihood[mockWind] || 1.0;
                prob *= windFaktor;
                
                // Normalisierung
                prob = Math.max(0, Math.min(100, Math.round(prob)));
                
                const klasse = prob >= 40 ? 'high' : (prob >= 20 ? 'medium' : 'low');
                
                let hinweis = '';
                if (tageSeit >= 1 && tageSeit <= 3) hinweis = 'üî• HOT ZONE!';
                else if (windFaktor > 1.5) hinweis = 'üî• Optimaler Wind';
                else if (windFaktor < 0.7) hinweis = '‚ùÑÔ∏è Ung√ºnstiger Wind';
                else if (relativ > 2.0) hinweis = 'üí§ Aus Routine';
                
                forecast.push({
                    label,
                    wind: mockWind,
                    prob,
                    klasse,
                    hinweis
                });
            }
            
            return forecast;
        }
        
        function berechneRhythmusFaktor(tageSeitBesuch, durchschnitt) {
            const relativ = tageSeitBesuch / durchschnitt;
            
            // PHASE 0: Gleiche Nacht
            if (tageSeitBesuch === 0) return 0.1;
            
            // PHASE 1: HOT ZONE (1-3 Tage)
            if (tageSeitBesuch >= 1 && tageSeitBesuch <= 3) return 3.0;
            
            // PHASE 2: Normal (4 bis Durchschnitt)
            if (tageSeitBesuch >= 4 && relativ <= 1.0) return 1.0;
            
            // PHASE 3: Leicht √ºberf√§llig (1-1.5√ó)
            if (relativ > 1.0 && relativ <= 1.5) return 1.2;
            
            // PHASE 4: Stark √ºberf√§llig (1.5-2√ó) - ABKLINGEND!
            if (relativ > 1.5 && relativ <= 2.0) return 1.0;
            
            // PHASE 5: VERGESSEN (>2√ó)
            return 0.3;
        }
        
        function berechneHotZoneBesuche(kirrungData) {
            let count = 0;
            const sorted = kirrungData.sort((a,b) => a.datum_parsed - b.datum_parsed);
            
            for (let i = 1; i < sorted.length; i++) {
                const diff = (sorted[i].datum_parsed - sorted[i-1].datum_parsed) / 86400000;
                if (diff >= 1 && diff <= 3) {
                    count++;
                }
            }
            
            return count;
        }
        
        function berechneDurchschnittIntervall(kirrungData) {
            if (kirrungData.length < 2) return 7;
            
            const sortiert = kirrungData.sort((a,b) => a.datum_parsed - b.datum_parsed);
            let summe = 0;
            
            for (let i = 1; i < sortiert.length; i++) {
                summe += (sortiert[i].datum_parsed - sortiert[i-1].datum_parsed) / 86400000;
            }
            
            return Math.round(summe / (sortiert.length - 1));
        }
        
        // ========================================
        // WIND-LIKELIHOOD (v1.1: 4 Gruppen!)
        // ========================================
        
        function calculateWindLikelihood(kirrungData, zeitraumTage) {
            const windCounts = {};
            const total = kirrungData.length;
            
            kirrungData.forEach(b => {
                const wind = parseWindGroup(b.windrichtung);
                if (wind) windCounts[wind] = (windCounts[wind] || 0) + 1;
            });
            
            // Baseline mit gleichem Zeitraum!
            const heute = new Date();
            const startDate = new Date(heute);
            startDate.setDate(startDate.getDate() - zeitraumTage);
            
            const baselineFiltered = wetterBaseline.filter(w => {
                if (!w.date) return false;
                const d = new Date(w.date);
                return d >= startDate && d <= heute;
            });
            
            const baselineCounts = {};
            baselineFiltered.forEach(w => {
                const wind = w.wdir_era5 || w.wdir_dwd || w.wdir;
                const group = parseWindGroup(wind);
                if (group) baselineCounts[group] = (baselineCounts[group] || 0) + 1;
            });
            
            const likelihood = {};
            ['N', 'S', 'O', 'W'].forEach(wind => {
                const pWindGivenVisit = (windCounts[wind] || 0) / total;
                const pWindBaseline = (baselineCounts[wind] || 0) / Math.max(1, baselineFiltered.length);
                
                likelihood[wind] = pWindBaseline > 0 ? pWindGivenVisit / pWindBaseline : 1.0;
            });
            
            return likelihood;
        }
        
        function parseWindGroup(windStr) {
            if (!windStr) return null;
            windStr = windStr.toString().toUpperCase();
            
            // Wind-Gruppierung v1.1:
            // N = N
            // S = S
            // O = O, NO, SO
            // W = W, NW, SW
            
            if (windStr.includes('NO') || windStr.includes('SO') || windStr.includes('O')) return 'O';
            if (windStr.includes('NW') || windStr.includes('SW') || windStr.includes('W')) return 'W';
            if (windStr.includes('S')) return 'S';
            if (windStr.includes('N')) return 'N';
            
            return null;
        }
        
        // ========================================
        // WIND-KORRELATION RENDERN (4 Balken!)
        // ========================================
        
        function renderWindKorrelation(alleBesuche, zeitraumTage) {
            const kirrungen = ['S√§gm√ºhle', 'Horlacher', 'Tiersbach'];
            document.getElementById('windKorrelation').innerHTML = kirrungen.map(kirrung => {
                const data = alleBesuche.filter(d => d.ort && d.ort.includes(kirrung));
                const likelihood = calculateWindLikelihood(data, zeitraumTage);
                
                // Nur 4 Richtungen!
                const bars = ['N', 'S', 'O', 'W'].sort((a,b) => (likelihood[b] || 0) - (likelihood[a] || 0)).map(wind => {
                    const ratio = likelihood[wind] || 1.0;
                    const diff = (ratio - 1.0) * 100;
                    const width = Math.abs(diff) * 2;
                    const type = diff > 5 ? 'positive' : (diff < -5 ? 'negative' : 'neutral');
                    const displayValue = ratio.toFixed(2) + 'x';
                    
                    return `
                        <div class="wind-bar">
                            <div class="wind-label">${wind}</div>
                            <div class="wind-bar-container">
                                <div class="wind-bar-fill ${type}" style="width: ${Math.min(width, 100)}%">
                                    ${Math.abs(diff) > 5 ? displayValue : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `<div class="wind-kirrung"><h3>${kirrung}</h3>${bars}</div>`;
            }).join('');
        }
        
        // ========================================
        // EINGABE PARSEN & REVIEW
        // ========================================
        
        function parseAndReview() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('Bitte Beschreibung eingeben!');
                return;
            }
            
            const parsed = parseNaturalLanguage(text);
            showReviewModal(parsed);
        }
        
        function parseNaturalLanguage(text) {
            const lower = text.toLowerCase();
            
            let datum = new Date();
            if (lower.includes('gestern')) {
                datum.setDate(datum.getDate() - 1);
            } else if (lower.includes('vorgestern')) {
                datum.setDate(datum.getDate() - 2);
            }
            const datumStr = datum.toISOString().split('T')[0];
            
            let ort = '';
            if (lower.includes('s√§ge')) ort = 'S√§gm√ºhle';
            else if (lower.includes('horl')) ort = 'Horlacher';
            else if (lower.includes('tier')) ort = 'Tiersbach';
            
            let anzahl = '';
            const zahlen = text.match(/(\d+)\s*(sau|schwein)/i);
            if (zahlen) anzahl = zahlen[1];
            
            let uhrzeitVon = '';
            const vonMatch = text.match(/(?:von|ab)\s*(\d{1,2}):?(\d{2})/i);
            if (vonMatch) {
                uhrzeitVon = vonMatch[1].padStart(2, '0') + ':' + vonMatch[2];
            }
            
            let uhrzeitBis = '';
            const bisMatch = text.match(/bis\s*(\d{1,2}):?(\d{2})/i);
            if (bisMatch) {
                uhrzeitBis = bisMatch[1].padStart(2, '0') + ':' + bisMatch[2];
            }
            
            return {
                datum: datumStr,
                ort: ort,
                anzahl: anzahl,
                uhrzeit_von: uhrzeitVon,
                uhrzeit_bis: uhrzeitBis,
                wildart: 'Schwarzwild',
                notizen: text
            };
        }
        
        function showReviewModal(parsed) {
            reviewedData = parsed;
            
            const fields = `
                <div class="review-field">
                    <div class="review-label">üìÖ Datum</div>
                    <div class="review-value">
                        <input type="date" id="review_datum" value="${parsed.datum}">
                    </div>
                </div>
                <div class="review-field">
                    <div class="review-label">üìç Ort</div>
                    <div class="review-value">
                        <select id="review_ort">
                            <option value="S√§gm√ºhle" ${parsed.ort === 'S√§gm√ºhle' ? 'selected' : ''}>S√§gm√ºhle</option>
                            <option value="Horlacher" ${parsed.ort === 'Horlacher' ? 'selected' : ''}>Horlacher</option>
                            <option value="Tiersbach" ${parsed.ort === 'Tiersbach' ? 'selected' : ''}>Tiersbach</option>
                        </select>
                    </div>
                </div>
                <div class="review-field">
                    <div class="review-label">üêó Anzahl</div>
                    <div class="review-value">
                        <input type="number" id="review_anzahl" value="${parsed.anzahl}" placeholder="z.B. 3">
                    </div>
                </div>
                <div class="review-field">
                    <div class="review-label">üïê Uhrzeit von</div>
                    <div class="review-value">
                        <input type="time" id="review_von" value="${parsed.uhrzeit_von}">
                    </div>
                </div>
                <div class="review-field">
                    <div class="review-label">üïê Uhrzeit bis</div>
                    <div class="review-value">
                        <input type="time" id="review_bis" value="${parsed.uhrzeit_bis}">
                    </div>
                </div>
                <div class="review-field">
                    <div class="review-label">üìù Notizen</div>
                    <div class="review-value">
                        <input type="text" id="review_notizen" value="${parsed.notizen}">
                    </div>
                </div>
            `;
            
            document.getElementById('reviewFields').innerHTML = fields;
            document.getElementById('reviewModal').style.display = 'block';
        }
        
        function closeReview() {
            document.getElementById('reviewModal').style.display = 'none';
            reviewedData = null;
        }
        
        async function saveFromReview() {
            const data = {
                datum: document.getElementById('review_datum').value,
                ort: document.getElementById('review_ort').value,
                anzahl: document.getElementById('review_anzahl').value,
                uhrzeit_von: document.getElementById('review_von').value,
                uhrzeit_bis: document.getElementById('review_bis').value,
                wildart: 'Schwarzwild',
                notizen: document.getElementById('review_notizen').value
            };
            
            try {
                const params = new URLSearchParams({ action: 'besuch', ...data });
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Besuch gespeichert!');
                    document.getElementById('textInput').value = '';
                    closeReview();
                    loadData();
                } else {
                    alert('‚ùå Fehler: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }
        
        // ========================================
        // KIRRUNG SPEICHERN
        // ========================================
        
        async function submitKirrung() {
            const datum = document.getElementById('kirrDatum').value;
            if (!datum) return alert('Bitte Datum w√§hlen!');
            
            const kirrungen = [];
            if (document.getElementById('kirr_saegemuehle').checked) kirrungen.push('S√§gm√ºhle');
            if (document.getElementById('kirr_horlacher').checked) kirrungen.push('Horlacher');
            if (document.getElementById('kirr_tiersbach').checked) kirrungen.push('Tiersbach');
            
            if (kirrungen.length === 0) return alert('Bitte mindestens eine Kirrung ausw√§hlen!');
            
            try {
                const url = `${API_URL}?action=kirrung&datum=${encodeURIComponent(datum)}&kirrungen=${encodeURIComponent(kirrungen.join(','))}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Kirrung gespeichert!\n${kirrungen.join(', ')}`);
                    document.getElementById('kirrDatum').valueAsDate = new Date();
                    document.querySelectorAll('.checkbox-item input').forEach(cb => cb.checked = false);
                    loadData();
                } else {
                    alert('‚ùå Fehler: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }
        
        // ========================================
        // TAB-WECHSEL
        // ========================================
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'besuch') {
                document.querySelector('.tab-button:nth-child(1)').classList.add('active');
                document.getElementById('besuchTab').classList.add('active');
            } else {
                document.querySelector('.tab-button:nth-child(2)').classList.add('active');
                document.getElementById('kirrTab').classList.add('active');
            }
        }
        
        // ========================================
        // HILFSFUNKTIONEN
        // ========================================
        
        function formatDatum(date) {
            const tage = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
            const monate = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            return `${tage[date.getDay()]}, ${date.getDate()}. ${monate[date.getMonth()]} ${date.getFullYear()}`;
        }
    </script>
</body>
</html>
