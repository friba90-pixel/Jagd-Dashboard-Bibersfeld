<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schwarzwild Dashboard V3.0 - Wissenschaftlich</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #2a4a2a 0%, #1a3a1a 100%);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; color: #fff; }
        .header-info { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; align-items: center; }
        select, .btn-reload {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
        }
        .btn-reload { background: #4CAF50; font-weight: 600; }
        .btn-reload:hover { background: #45a049; }
        
        /* Eingabe */
        .input-section { background: #2d2d2d; padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        .input-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #444; }
        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1em;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active { color: #4CAF50; border-bottom-color: #4CAF50; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.95em; }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 1em;
            font-family: inherit;
        }
        .checkbox-group { display: flex; gap: 20px; flex-wrap: wrap; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .submit-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
        }
        
        /* Review Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background: #2d2d2d;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
        }
        .modal-header {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #4CAF50;
        }
        .review-field {
            margin-bottom: 15px;
            padding: 12px;
            background: #1a1a1a;
            border-radius: 8px;
        }
        .review-label { color: #999; font-size: 0.9em; }
        .review-value { color: #fff; font-size: 1.1em; font-weight: 600; display: flex; gap: 10px; }
        .review-value input, .review-value select {
            flex: 1;
            padding: 8px;
            background: #2d2d2d;
            border: 1px solid #555;
            border-radius: 5px;
            color: #fff;
        }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; justify-content: flex-end; }
        .btn-cancel, .btn-save { padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; }
        .btn-cancel { background: #666; color: #fff; }
        .btn-save { background: #4CAF50; color: #fff; }
        
        /* Kirrungen */
        .kirrungen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .kirrung-card { background: #2d2d2d; padding: 25px; border-radius: 15px; }
        .kirrung-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .kirrung-title { font-size: 1.5em; color: #fff; }
        .ampel {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }
        .ampel.gruen { background: #4CAF50; box-shadow: 0 0 20px rgba(76, 175, 80, 0.6); }
        .ampel.rot { background: #f44336; box-shadow: 0 0 20px rgba(244, 67, 54, 0.6); }
        .kirr-status { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #444; }
        .stat-label { color: #999; }
        .stat-value { color: #fff; font-weight: 600; }
        
        /* Statistiken */
        .kirrung-stats { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; }
        .stat-box h4 { font-size: 0.9em; color: #4CAF50; margin-bottom: 10px; }
        .stat-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; font-size: 0.85em; }
        .stat-bar-label { width: 30px; color: #999; }
        .stat-bar-fill {
            height: 18px;
            background: #4CAF50;
            border-radius: 3px;
            padding: 0 5px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            color: #fff;
        }
        
        /* Forecast */
        .forecast-section { margin-top: 20px; }
        .forecast-title { font-size: 1.1em; margin-bottom: 15px; color: #4CAF50; }
        .forecast-day { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 10px; }
        .forecast-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .forecast-date { font-weight: 600; }
        .forecast-prob { font-size: 1.5em; font-weight: 700; }
        .forecast-prob.high { color: #4CAF50; }
        .forecast-prob.medium { color: #FFC107; }
        .forecast-prob.low { color: #f44336; }
        .forecast-details { display: flex; gap: 15px; flex-wrap: wrap; font-size: 0.9em; color: #999; }
        
        /* Wind-Korrelation */
        .wind-korrelation { background: #2d2d2d; padding: 25px; border-radius: 15px; margin-top: 30px; }
        .wind-korrelation h2 { margin-bottom: 20px; color: #fff; }
        .wind-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .wind-kirrung h3 { margin-bottom: 15px; color: #4CAF50; }
        .wind-category { margin-bottom: 25px; }
        .wind-category-title { font-size: 0.95em; color: #FFC107; margin-bottom: 10px; font-weight: 600; }
        .wind-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .wind-label { width: 40px; text-align: right; color: #999; font-weight: 600; }
        .wind-bar-container { flex: 1; height: 28px; background: #1a1a1a; border-radius: 5px; overflow: hidden; }
        .wind-bar-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: #fff;
            font-size: 0.9em;
            font-weight: 600;
        }
        .wind-bar-fill.positive { background: linear-gradient(90deg, #4CAF50 0%, #66BB6A 100%); }
        .wind-bar-fill.negative { background: linear-gradient(90deg, #f44336 0%, #EF5350 100%); }
        .wind-bar-fill.neutral { background: #666; }
        
        #loading { text-align: center; padding: 50px; font-size: 1.2em; }
        
        @media (max-width: 768px) {
            .kirrungen-grid, .wind-grid { grid-template-columns: 1fr; }
            .kirrung-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêó Schwarzwild Dashboard V3.0 - Wissenschaftlich</h1>
            <div class="header-info">
                <span id="currentDate"></span>
                <select id="zeitraumFilter">
                    <option value="all">Alle Daten</option>
                    <option value="12m">Letzte 12 Monate</option>
                    <option value="3m" selected>Letzte 3 Monate</option>
                    <option value="1m">Letzter Monat</option>
                </select>
                <button class="btn-reload" onclick="loadData()">üîÑ Aktualisieren</button>
                <span id="totalVisits">L√§dt...</span>
            </div>
        </div>
        
        <div id="loading">‚è≥ Lade Daten...</div>
        
        <div id="mainContent" style="display: none;">
            <div class="input-section">
                <div class="input-tabs">
                    <button class="tab-button active" onclick="switchTab('besuch')">üêó Schwarzwild-Besuch</button>
                    <button class="tab-button" onclick="switchTab('kirr')">üåΩ Kirrung best√ºckt</button>
                </div>
                
                <div id="besuchTab" class="tab-content active">
                    <div class="input-group">
                        <label>üìù Nat√ºrliche Eingabe</label>
                        <input type="text" id="textInput" placeholder="Heute Nacht 3 Sauen S√§gm√ºhle von 21:30 bis 22:15">
                    </div>
                    <button class="submit-btn" onclick="parseAndReview()">üìù Eingabe pr√ºfen</button>
                </div>
                
                <div id="kirrTab" class="tab-content">
                    <div class="input-group">
                        <label>üìÖ Datum</label>
                        <input type="date" id="kirrDatum">
                    </div>
                    <div class="input-group">
                        <label>üåΩ Welche Kirrungen best√ºckt?</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="kirr_saegemuehle">
                                <label for="kirr_saegemuehle">S√§gm√ºhle</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="kirr_horlacher">
                                <label for="kirr_horlacher">Horlacher</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="kirr_tiersbach">
                                <label for="kirr_tiersbach">Tiersbach</label>
                            </div>
                        </div>
                    </div>
                    <button class="submit-btn" onclick="submitKirrung()">üíæ Best√ºckung speichern</button>
                </div>
            </div>
            
            <div class="kirrungen-grid" id="kirrungen"></div>
            
            <div class="wind-korrelation">
                <h2>üí® Windrichtungs-Abh√§ngigkeit (Likelihood Ratios)</h2>
                <p style="color: #999; margin-bottom: 20px;">P(Wind|Besuch) / P(Wind|Baseline) - Hot-Zone vs Normal</p>
                <div class="wind-grid" id="windKorrelation"></div>
            </div>
        </div>
        
        <div id="reviewModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">üìã Eingabe √ºberpr√ºfen</div>
                <div id="reviewFields"></div>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeReview()">‚ùå Abbrechen</button>
                    <button class="btn-save" onclick="saveFromReview()">üíæ Speichern</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ========================================
        // KONFIGURATION
        // ========================================
        
        // TODO: ERSETZE MIT DEINER APPS SCRIPT URL!
        const API_URL = 'https://script.google.com/macros/s/AKfycbzIc0_KrKcJLSEdX895r7v2ooMTuVEgVrD-7TKRH9Cm79h9sRJ2xxMi-7w9dUVuysV8Zg/exec';
        
        let allData = [], filteredData = [], wetterBaseline = [], kirrbest√ºckungen = [];
        let reviewedData = null;
        
        // ========================================
        // INIT
        // ========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentDate').textContent = formatDatum(new Date());
            document.getElementById('kirrDatum').valueAsDate = new Date();
            document.getElementById('zeitraumFilter').addEventListener('change', () => applyZeitraumFilter(allData));
            loadData();
        });
        
        // ========================================
        // DATEN LADEN
        // ========================================
        
        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            
            try {
                const response = await fetch(API_URL);
                const json = await response.json();
                
                if (!json.success) throw new Error(json.error);
                
                allData = (json.data || []).map(parseBesuch);
                wetterBaseline = json.wetter_baseline || [];
                
                console.log('‚úÖ Geladen:', allData.length, 'Eintr√§ge');
                console.log('‚úÖ Wetter-Baseline:', wetterBaseline.length, 'Tage');
                
                applyZeitraumFilter(allData);
            } catch (error) {
                console.error('Fehler:', error);
                document.getElementById('loading').innerHTML = `<div style="color:#f44336">‚ùå ${error.message}</div>`;
            }
        }
        
        function parseBesuch(item) {
            let datum = item.datum_nacht;
            
            if (!datum) return { ...item, datum_parsed: null };
            
            if (typeof datum === 'string') {
                datum = new Date(datum);
            } else if (typeof datum === 'number') {
                datum = new Date((datum - 25569) * 86400000);
            } else if (!(datum instanceof Date)) {
                return { ...item, datum_parsed: null };
            }
            
            if (isNaN(datum.getTime())) {
                return { ...item, datum_parsed: null };
            }
            
            return { ...item, datum_parsed: datum };
        }
        
        // ========================================
        // FILTER
        // ========================================
        
        function applyZeitraumFilter(sourceData) {
            const zeitraum = document.getElementById('zeitraumFilter').value;
            const heute = new Date();
            let startDate = new Date(0);
            
            if (zeitraum === '1m') {
                startDate = new Date(heute);
                startDate.setMonth(startDate.getMonth() - 1);
            } else if (zeitraum === '3m') {
                startDate = new Date(heute);
                startDate.setMonth(startDate.getMonth() - 3);
            } else if (zeitraum === '12m') {
                startDate = new Date(heute);
                startDate.setMonth(startDate.getMonth() - 12);
            }
            
            const mitDatum = sourceData.filter(d => d.datum_parsed);
            const alleBesuche = mitDatum.filter(d => d.art === 'Kirrbesuch');
            const besuche = mitDatum.filter(d => d.datum_parsed >= startDate && d.art === 'Kirrbesuch');
            kirrbest√ºckungen = mitDatum.filter(d => d.art === 'Kirrbest√ºckung');
            
            filteredData = besuche;
            renderDashboard(alleBesuche);
        }
        
        // ========================================
        // DASHBOARD RENDERN
        // ========================================
        
        function renderDashboard(alleBesuche) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('totalVisits').textContent = `${filteredData.length} Besuche (angezeigt)`;
            
            renderKirrungen(alleBesuche);
            renderWindKorrelation(alleBesuche);
        }
        
        // ========================================
        // KIRRUNGEN RENDERN
        // ========================================
        
        function renderKirrungen(alleBesuche) {
            const kirrungen = ['S√§gm√ºhle', 'Horlacher', 'Tiersbach'];
            document.getElementById('kirrungen').innerHTML = kirrungen.map(k => {
                const data = alleBesuche.filter(d => d.ort && d.ort.includes(k.substring(0,4)));
                return createKirrungCard(k, data, alleBesuche);
            }).join('');
        }
        
        function createKirrungCard(kirrung, kirrungData, alleBesuche) {
            const stats = calculateKirrungStats(kirrungData);
            const forecast = calculateSmartForecast(kirrung, alleBesuche);
            const status = getKirrStatus(kirrung, kirrungData);
            const wochentagStats = calculateWochentagStats(kirrungData);
            const uhrzeitStats = calculateUhrzeitStats(kirrungData);
            const rates = calculateCategoryRates(kirrungData);
            
            return `
                <div class="kirrung-card">
                    <div class="kirrung-header">
                        <div class="kirrung-title">${kirrung}</div>
                        <div class="ampel ${status.ampel}">${status.icon}</div>
                    </div>
                    <div class="kirr-status">${status.text}</div>
                    <div class="stat-row">
                        <span class="stat-label">Gesamt-Besuche</span>
                        <span class="stat-value">${kirrungData.length}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Letzter Besuch</span>
                        <span class="stat-value">${stats.letzter}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Letzte Best√ºckung</span>
                        <span class="stat-value">${status.letzteKirr}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Hot-Zone Rate</span>
                        <span class="stat-value">${rates.hot_zone}%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Normal Rate</span>
                        <span class="stat-value">${rates.normal}%</span>
                    </div>
                    
                    <div class="kirrung-stats">
                        <div class="stat-box">
                            <h4>üìÖ Wochentage</h4>
                            ${wochentagStats}
                        </div>
                        <div class="stat-box">
                            <h4>üïê Uhrzeiten (18-07h)</h4>
                            ${uhrzeitStats}
                        </div>
                    </div>
                    
                    <div class="forecast-section">
                        <div class="forecast-title">üìä 4-Tage Wissenschaftlicher Forecast</div>
                        ${forecast.map(f => `
                            <div class="forecast-day">
                                <div class="forecast-header">
                                    <div class="forecast-date">${f.label}</div>
                                    <div class="forecast-prob ${f.klasse}">${f.prob}%</div>
                                </div>
                                <div class="forecast-details">
                                    <div>üí® ${f.wind}</div>
                                    <div>üìÖ ${f.wochentag}</div>
                                    <div>üåßÔ∏è ${f.niederschlag}mm</div>
                                    <div>${f.hinweis}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function calculateKirrungStats(data) {
            if (data.length === 0) return { letzter: 'Keine Daten' };
            
            const neuester = data.reduce((max, d) => d.datum_parsed > max ? d.datum_parsed : max, data[0].datum_parsed);
            const tage = Math.floor((new Date() - neuester) / 86400000);
            
            return { letzter: tage === 0 ? 'Heute' : `vor ${tage} Tag${tage === 1 ? '' : 'en'}` };
        }
        
        function calculateCategoryRates(data) {
            if (data.length < 2) return { hot_zone: 0, normal: 0, late: 0, forgotten: 0 };
            
            const intervals = [];
            const sorted = data.sort((a,b) => a.datum_parsed - b.datum_parsed);
            
            for (let i = 1; i < sorted.length; i++) {
                const days = Math.floor((sorted[i].datum_parsed - sorted[i-1].datum_parsed) / 86400000);
                intervals.push(days);
            }
            
            const totalIntervals = intervals.length;
            
            const hotZone = intervals.filter(d => d >= 1 && d <= 3).length;
            const normal = intervals.filter(d => d >= 4 && d <= 7).length;
            const late = intervals.filter(d => d >= 8 && d <= 14).length;
            const forgotten = intervals.filter(d => d > 14).length;
            
            return {
                hot_zone: ((hotZone / 3 / totalIntervals) * 100).toFixed(1),
                normal: ((normal / 4 / totalIntervals) * 100).toFixed(1),
                late: ((late / 7 / totalIntervals) * 100).toFixed(1),
                forgotten: ((forgotten / 76 / totalIntervals) * 100).toFixed(1)
            };
        }
        
        function calculateWochentagStats(data) {
            const tage = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            const counts = [0,0,0,0,0,0,0];
            
            data.forEach(d => {
                if (d.datum_parsed) {
                    const idx = (d.datum_parsed.getDay() + 6) % 7;
                    counts[idx]++;
                }
            });
            
            const max = Math.max(...counts, 1);
            return tage.map((t, i) => {
                const width = (counts[i] / max) * 100;
                return `
                    <div class="stat-bar">
                        <div class="stat-bar-label">${t}</div>
                        <div class="stat-bar-fill" style="width: ${width}%">${counts[i]}</div>
                    </div>
                `;
            }).join('');
        }
        
        function calculateUhrzeitStats(data) {
            const counts = {};
            const hours = [18,19,20,21,22,23,0,1,2,3,4,5,6,7];
            
            data.forEach(d => {
                if (d.uhrzeit_von) {
                    const h = parseInt(d.uhrzeit_von.toString().split(':')[0]);
                    if (!isNaN(h)) {
                        counts[h] = (counts[h] || 0) + 1;
                    }
                }
            });
            
            const max = Math.max(...Object.values(counts), 1);
            
            return hours.map(h => {
                const c = counts[h] || 0;
                const width = (c / max) * 100;
                const label = h === 0 ? '00h' : `${h}h`;
                return `
                    <div class="stat-bar">
                        <div class="stat-bar-label">${label}</div>
                        <div class="stat-bar-fill" style="width: ${width}%">${c}</div>
                    </div>
                `;
            }).join('');
        }
        
        function getKirrStatus(kirrung, kirrungData) {
            const heute = new Date();
            
            const alleKirrungen = kirrbest√ºckungen.filter(k => k.ort && k.ort.includes(kirrung));
            const letzteKirr = alleKirrungen.sort((a,b) => b.datum_parsed - a.datum_parsed)[0];
            
            if (!letzteKirr) {
                return { 
                    ampel: 'rot', 
                    icon: 'üî¥', 
                    text: '‚ö†Ô∏è Noch nie best√ºckt',
                    letzteKirr: 'Nie' 
                };
            }
            
            const tageSeitKirr = Math.floor((heute - letzteKirr.datum_parsed) / 86400000);
            const besucheSeit = kirrungData.filter(d => d.datum_parsed > letzteKirr.datum_parsed);
            const letzteKirrText = tageSeitKirr === 0 ? 'Heute' : `vor ${tageSeitKirr} Tag${tageSeitKirr === 1 ? '' : 'en'}`;
            
            if (besucheSeit.length > 0) {
                return { 
                    ampel: 'rot', 
                    icon: 'üî¥', 
                    text: `üêó ${besucheSeit.length} Besuch(e) seit ${letzteKirrText} ‚Üí Nachkirren!`,
                    letzteKirr: letzteKirrText
                };
            } else if (tageSeitKirr > 10) {
                return { 
                    ampel: 'rot', 
                    icon: 'üî¥', 
                    text: `‚è∞ ${tageSeitKirr} Tage ohne Best√ºckung ‚Üí Best√ºcken!`,
                    letzteKirr: letzteKirrText
                };
            } else {
                return { 
                    ampel: 'gruen', 
                    icon: 'üü¢', 
                    text: `‚úÖ Best√ºckt ${letzteKirrText} ¬∑ Keine Besuche`,
                    letzteKirr: letzteKirrText
                };
            }
        }
        
        // Fortsetzung folgt...
        
        // ========================================
        // WISSENSCHAFTLICHER FORECAST
        // ========================================
        
        function calculateSmartForecast(kirrung, alleBesuche) {
            const kirrungData = alleBesuche.filter(d => d.ort && d.ort.includes(kirrung));
            
            if (kirrungData.length < 3) {
                return [{label: 'Zu wenig Daten', prob: 0, klasse: 'low', wind: '-', wochentag: '-', niederschlag: 0, hinweis: 'Min. 3 Besuche n√∂tig'}];
            }
            
            const forecast = [];
            const letzterBesuch = kirrungData.length > 0 ? 
                kirrungData.reduce((max, d) => d.datum_parsed > max ? d.datum_parsed : max, kirrungData[0].datum_parsed) : 
                null;
            
            // Baseline f√ºr Zeitraum filtern
            const zeitraum = document.getElementById('zeitraumFilter').value;
            const baseline = filterBaselineByZeitraum(wetterBaseline, zeitraum);
            
            // Wind-Likelihood berechnen
            const windLH_HotZone = calculateWindLikelihood(kirrungData, baseline, true);
            const windLH_Normal = calculateWindLikelihood(kirrungData, baseline, false);
            
            for (let i = 0; i < 4; i++) {
                const datum = new Date();
                datum.setDate(datum.getDate() + i);
                
                const label = i === 0 ? 'HEUTE' : (i === 1 ? 'MORGEN' : ['So','Mo','Di','Mi','Do','Fr','Sa'][datum.getDay()]);
                const wochentag = ['So','Mo','Di','Mi','Do','Fr','Sa'][datum.getDay()];
                
                // Mock-Wetter (TODO: Echte API)
                const mockWind = ['S', 'SW', 'W', 'N'][i];
                const mockNiederschlag = [0, 2, 5, 0][i];
                
                const tageSeit = letzterBesuch ? Math.floor((datum - letzterBesuch) / 86400000) : 999;
                
                // Empirische Rate
                let prob = getEmpiricalRate(tageSeit, kirrungData);
                
                // Wind-Adjustment
                const isHotZone = tageSeit <= 3;
                const windLH = isHotZone ? windLH_HotZone : windLH_Normal;
                const windFaktor = windLH[mockWind] || 1.0;
                const maxWind = isHotZone ? 5 : (tageSeit <= 14 ? 10 : 15);
                prob += (windFaktor - 1.0) * maxWind;
                
                // Niederschlag-Adjustment
                prob += getNiederschlagAdjustment(mockNiederschlag, isHotZone);
                
                // Wochentag-Adjustment
                prob += getWochentagAdjustment(wochentag, kirrungData);
                
                // Begrenzen
                prob = Math.max(0, Math.min(100, Math.round(prob)));
                
                const klasse = prob >= 40 ? 'high' : (prob >= 20 ? 'medium' : 'low');
                
                let hinweis = '';
                if (tageSeit >= 1 && tageSeit <= 3) hinweis = 'üî• HOT ZONE';
                else if (windFaktor > 1.5) hinweis = 'üî• Optimaler Wind';
                else if (windFaktor < 0.7) hinweis = '‚ùÑÔ∏è Ung√ºnstiger Wind';
                else if (tageSeit > 30) hinweis = 'üí§ Aus Routine';
                else if (mockNiederschlag > 5) hinweis = 'üåßÔ∏è Starker Regen';
                
                forecast.push({
                    label: `${label} ${datum.getDate()}.${datum.getMonth()+1}.`,
                    wind: mockWind,
                    wochentag: wochentag,
                    niederschlag: mockNiederschlag,
                    prob,
                    klasse,
                    hinweis
                });
            }
            
            return forecast;
        }
        
        function getEmpiricalRate(daysSince, kirrungData) {
            if (daysSince === 0) return 0.5;
            if (kirrungData.length < 2) return 5;
            
            const intervals = [];
            const sorted = kirrungData.sort((a,b) => a.datum_parsed - b.datum_parsed);
            
            for (let i = 1; i < sorted.length; i++) {
                const days = Math.floor((sorted[i].datum_parsed - sorted[i-1].datum_parsed) / 86400000);
                intervals.push(days);
            }
            
            const totalIntervals = intervals.length;
            
            if (daysSince <= 3) {
                const count = intervals.filter(d => d >= 1 && d <= 3).length;
                return (count / 3 / totalIntervals) * 100;
            } else if (daysSince <= 7) {
                const count = intervals.filter(d => d >= 4 && d <= 7).length;
                return (count / 4 / totalIntervals) * 100;
            } else if (daysSince <= 14) {
                const count = intervals.filter(d => d >= 8 && d <= 14).length;
                return (count / 7 / totalIntervals) * 100;
            } else {
                const count = intervals.filter(d => d > 14).length;
                return (count / 76 / totalIntervals) * 100;
            }
        }
        
        function getNiederschlagAdjustment(niederschlag_mm, isHotZone) {
            if (!niederschlag_mm || niederschlag_mm === 0) return 0;
            
            let malus = 0;
            if (niederschlag_mm < 2) malus = -2;
            else if (niederschlag_mm < 5) malus = -5;
            else if (niederschlag_mm < 10) malus = -8;
            else malus = -12;
            
            // Hot-Zone: Hunger √ºberwiegt
            if (isHotZone) malus = malus / 2;
            
            return malus;
        }
        
        function getWochentagAdjustment(wochentag, kirrungData) {
            const tage = ['So','Mo','Di','Mi','Do','Fr','Sa'];
            const counts = Array(7).fill(0);
            
            kirrungData.forEach(b => {
                if (b.datum_parsed) {
                    const idx = b.datum_parsed.getDay();
                    counts[idx]++;
                }
            });
            
            const total = kirrungData.length;
            const baseline = 1.0 / 7;
            
            const idx = tage.indexOf(wochentag);
            const empirical = counts[idx] / total;
            const faktor = empirical / baseline;
            
            return (faktor - 1.0) * 3;
        }
        
        // ========================================
        // WIND-LIKELIHOOD (8 RICHTUNGEN!)
        // ========================================
        
        function calculateWindLikelihood(besuche, baseline, isHotZone) {
            const windLikelihood = {};
            
            // Filtere nach Hot-Zone oder Normal
            const filtered = besuche.filter((b, i) => {
                if (i === 0) return !isHotZone;
                const sorted = besuche.sort((a,b) => a.datum_parsed - b.datum_parsed);
                const daysSince = (b.datum_parsed - sorted[i-1].datum_parsed) / 86400000;
                return isHotZone ? (daysSince >= 1 && daysSince <= 3) : (daysSince > 3);
            });
            
            // ALLE 8 Windrichtungen
            for (const wind of ['N','NO','O','SO','S','SW','W','NW']) {
                const countInVisits = filtered.filter(b => extractWind(b.windrichtung) === wind).length;
                const p_wind_given_visit = countInVisits / Math.max(filtered.length, 1);
                
                const countInBaseline = baseline.filter(w => (w.wdir_era5 || w.wdir_dwd) === wind).length;
                const p_wind_baseline = countInBaseline / Math.max(baseline.length, 1);
                
                windLikelihood[wind] = p_wind_baseline > 0 ? p_wind_given_visit / p_wind_baseline : 1.0;
            }
            
            return windLikelihood;
        }
        
        function extractWind(windString) {
            if (!windString) return null;
            const match = windString.match(/^(N|NO|O|SO|S|SW|W|NW)/i);
            return match ? match[1].toUpperCase() : null;
        }
        
        function filterBaselineByZeitraum(baseline, zeitraum) {
            if (zeitraum === 'all') return baseline;
            
            const heute = new Date();
            let startDate = new Date(0);
            
            if (zeitraum === '1m') {
                startDate = new Date(heute);
                startDate.setMonth(startDate.getMonth() - 1);
            } else if (zeitraum === '3m') {
                startDate = new Date(heute);
                startDate.setMonth(startDate.getMonth() - 3);
            } else if (zeitraum === '12m') {
                startDate = new Date(heute);
                startDate.setMonth(startDate.getMonth() - 12);
            }
            
            return baseline.filter(w => {
                const date = new Date(w.date);
                return date >= startDate;
            });
        }
        
        // ========================================
        // WIND-KORRELATION RENDERN
        // ========================================
        
        function renderWindKorrelation(alleBesuche) {
            const kirrungen = ['S√§gm√ºhle', 'Horlacher', 'Tiersbach'];
            const zeitraum = document.getElementById('zeitraumFilter').value;
            const baseline = filterBaselineByZeitraum(wetterBaseline, zeitraum);
            
            document.getElementById('windKorrelation').innerHTML = kirrungen.map(kirrung => {
                const data = alleBesuche.filter(d => d.ort && d.ort.includes(kirrung));
                
                const windLH_HotZone = calculateWindLikelihood(data, baseline, true);
                const windLH_Normal = calculateWindLikelihood(data, baseline, false);
                
                return `
                    <div class="wind-kirrung">
                        <h3>${kirrung}</h3>
                        
                        <div class="wind-category">
                            <div class="wind-category-title">üî• Hot-Zone (1-3 Tage)</div>
                            ${renderWindBars(windLH_HotZone)}
                        </div>
                        
                        <div class="wind-category">
                            <div class="wind-category-title">üìç Normal (>3 Tage)</div>
                            ${renderWindBars(windLH_Normal)}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderWindBars(windLH) {
            const sorted = Object.entries(windLH).sort((a,b) => b[1] - a[1]);
            
            return sorted.map(([wind, ratio]) => {
                const diff = (ratio - 1.0) * 100;
                const width = Math.min(Math.abs(diff) * 2, 100);
                const type = diff > 5 ? 'positive' : (diff < -5 ? 'negative' : 'neutral');
                const displayValue = ratio.toFixed(2) + 'x';
                
                return `
                    <div class="wind-bar">
                        <div class="wind-label">${wind}</div>
                        <div class="wind-bar-container">
                            <div class="wind-bar-fill ${type}" style="width: ${width}%">
                                ${Math.abs(diff) > 5 ? displayValue : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Fortsetzung folgt...
        
        // ========================================
        // EINGABE PARSEN & REVIEW
        // ========================================
        
        function parseAndReview() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) {
                alert('Bitte Beschreibung eingaben!');
                return;
            }
            
            const parsed = parseNaturalLanguage(text);
            showReviewModal(parsed);
        }
        
        function parseNaturalLanguage(text) {
            const lower = text.toLowerCase();
            
            let datum = new Date();
            if (lower.includes('gestern')) {
                datum.setDate(datum.getDate() - 1);
            } else if (lower.includes('vorgestern')) {
                datum.setDate(datum.getDate() - 2);
            }
            const datumStr = datum.toISOString().split('T')[0];
            
            let ort = '';
            if (lower.includes('s√§ge')) ort = 'S√§gm√ºhle';
            else if (lower.includes('horl')) ort = 'Horlacher';
            else if (lower.includes('tier')) ort = 'Tiersbach';
            
            let anzahl = '';
            const zahlen = text.match(/(\d+)\s*(sau|schwein)/i);
            if (zahlen) anzahl = zahlen[1];
            
            let uhrzeitVon = '';
            const vonMatch = text.match(/(?:von|ab)\s*(\d{1,2}):?(\d{2})/i);
            if (vonMatch) {
                uhrzeitVon = vonMatch[1].padStart(2, '0') + ':' + vonMatch[2];
            }
            
            let uhrzeitBis = '';
            const bisMatch = text.match(/bis\s*(\d{1,2}):?(\d{2})/i);
            if (bisMatch) {
                uhrzeitBis = bisMatch[1].padStart(2, '0') + ':' + bisMatch[2];
            }
            
            return {
                datum: datumStr,
                ort: ort,
                anzahl: anzahl,
                uhrzeit_von: uhrzeitVon,
                uhrzeit_bis: uhrzeitBis,
                wildart: 'Schwarzwild',
                notizen: text
            };
        }
        
        function showReviewModal(parsed) {
            reviewedData = parsed;
            
            const fields = `
                <div class="review-field">
                    <div class="review-label">üìÖ Datum</div>
                    <div class="review-value">
                        <input type="date" id="review_datum" value="${parsed.datum}">
                    </div>
                </div>
                <div class="review-field">
                    <div class="review-label">üìç Ort</div>
                    <div class="review-value">
                        <select id="review_ort">
                            <option value="S√§gm√ºhle" ${parsed.ort === 'S√§gm√ºhle' ? 'selected' : ''}>S√§gm√ºhle</option>
                            <option value="Horlacher" ${parsed.ort === 'Horlacher' ? 'selected' : ''}>Horlacher</option>
                            <option value="Tiersbach" ${parsed.ort === 'Tiersbach' ? 'selected' : ''}>Tiersbach</option>
                        </select>
                    </div>
                </div>
                <div class="review-field">
                    <div class="review-label">üêó Anzahl</div>
                    <div class="review-value">
                        <input type="number" id="review_anzahl" value="${parsed.anzahl}" placeholder="z.B. 3">
                    </div>
                </div>
                <div class="review-field">
                    <div class="review-label">üïê Uhrzeit von</div>
                    <div class="review-value">
                        <input type="time" id="review_von" value="${parsed.uhrzeit_von}">
                    </div>
                </div>
                <div class="review-field">
                    <div class="review-label">üïê Uhrzeit bis</div>
                    <div class="review-value">
                        <input type="time" id="review_bis" value="${parsed.uhrzeit_bis}">
                    </div>
                </div>
                <div class="review-field">
                    <div class="review-label">üìù Notizen</div>
                    <div class="review-value">
                        <input type="text" id="review_notizen" value="${parsed.notizen}">
                    </div>
                </div>
            `;
            
            document.getElementById('reviewFields').innerHTML = fields;
            document.getElementById('reviewModal').style.display = 'block';
        }
        
        function closeReview() {
            document.getElementById('reviewModal').style.display = 'none';
            reviewedData = null;
        }
        
        async function saveFromReview() {
            const data = {
                datum: document.getElementById('review_datum').value,
                ort: document.getElementById('review_ort').value,
                anzahl: document.getElementById('review_anzahl').value,
                uhrzeit_von: document.getElementById('review_von').value,
                uhrzeit_bis: document.getElementById('review_bis').value,
                wildart: 'Schwarzwild',
                notizen: document.getElementById('review_notizen').value
            };
            
            try {
                const params = new URLSearchParams({ action: 'besuch', ...data });
                const response = await fetch(`${API_URL}?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Besuch gespeichert!');
                    document.getElementById('textInput').value = '';
                    closeReview();
                    loadData();
                } else {
                    alert('‚ùå Fehler: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }
        
        // ========================================
        // KIRRUNG SPEICHERN
        // ========================================
        
        async function submitKirrung() {
            const datum = document.getElementById('kirrDatum').value;
            if (!datum) return alert('Bitte Datum w√§hlen!');
            
            const kirrungen = [];
            if (document.getElementById('kirr_saegemuehle').checked) kirrungen.push('S√§gm√ºhle');
            if (document.getElementById('kirr_horlacher').checked) kirrungen.push('Horlacher');
            if (document.getElementById('kirr_tiersbach').checked) kirrungen.push('Tiersbach');
            
            if (kirrungen.length === 0) return alert('Bitte mindestens eine Kirrung ausw√§hlen!');
            
            try {
                const url = `${API_URL}?action=kirrung&datum=${encodeURIComponent(datum)}&kirrungen=${encodeURIComponent(kirrungen.join(','))}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Kirrung gespeichert!\n${kirrungen.join(', ')}`);
                    document.getElementById('kirrDatum').valueAsDate = new Date();
                    document.querySelectorAll('.checkbox-item input').forEach(cb => cb.checked = false);
                    loadData();
                } else {
                    alert('‚ùå Fehler: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Fehler: ' + error.message);
            }
        }
        
        // ========================================
        // TAB-WECHSEL
        // ========================================
        
        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'besuch') {
                document.querySelector('.tab-button:nth-child(1)').classList.add('active');
                document.getElementById('besuchTab').classList.add('active');
            } else {
                document.querySelector('.tab-button:nth-child(2)').classList.add('active');
                document.getElementById('kirrTab').classList.add('active');
            }
        }
        
        // ========================================
        // HILFSFUNKTIONEN
        // ========================================
        
        function formatDatum(date) {
            const tage = ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'];
            const monate = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
            return `${tage[date.getDay()]}, ${date.getDate()}. ${monate[date.getMonth()]} ${date.getFullYear()}`;
        }
    </script>
</body>
</html>
